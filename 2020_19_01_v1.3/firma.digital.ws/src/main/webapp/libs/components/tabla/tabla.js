var Tabla=function(id,metadata,callbacks){this.id=id;this.metadata=metadata;this.callbacks=callbacks||metadata.callbacks;this.initialized=false;this.init();};Tabla.prototype=(function(){function init(){let $=this;if($.initialized){return;}let id=$.id;let metadata=$.metadata;let columnas=metadata.columns.length;let headerTemplate=metadata.headerTemplate||'_header_tabla_';dom.append('header_'+id,headerTemplate,metadata);if(typeof(metadata.isEditable)==='undefined'||metadata.isEditable){let footerTemplate=metadata.footerTemplate||'_footer_tabla_';let totalColumnas=columnas+((metadata.actions)?metadata.actions.length:0);dom.append('footer_'+id,footerTemplate,{totalColumnas:totalColumnas,module:metadata.module});}if(metadata.pagination){dom.append('list_'+id,'_paginador_',{id:id});}dom.onClick(jQuery('#header_'+id+' .sortable'),generate_on_click_sortable_column_callback($));dom.onClick('page_'+id,generate_on_click_listado_callback($));$.initialized=true;}function reshape(metadata){let $=this;let id=$.id;$.metadata=metadata;let columnas=metadata.columns.length;let headerTemplate=metadata.headerTemplate||'_header_tabla_';dom.create('header_'+id,headerTemplate,metadata);if(typeof(metadata.isEditable)==='undefined'||metadata.isEditable){let footerTemplate=metadata.footerTemplate||'_footer_tabla_';let totalColumnas=columnas+1;dom.create('footer_'+id,footerTemplate,{totalColumnas:totalColumnas,module:metadata.module});}dom.onClick(jQuery('#header_'+id+' .sortable'),generate_on_click_sortable_column_callback($));$.update(1);}function update(page){let $=this;if(page&&$.metadata.search.paginacion){$.metadata.search.paginacion.pagina=page;}setTimeout(function(){consultar_informacion($,true);},0);}function obtener_pagina(pagina){let $=this;if(pagina){$.metadata.search.paginacion.pagina=pagina;}setTimeout(function(){consultar_informacion($,false);},0);}function consultar_informacion($,actualizarTotal){if($.callbacks.request_data){$.callbacks.request_data($.metadata.search,function(items,consulta){add_items($,items,consulta);});}else{let search=$.metadata.search;let resource=$.metadata.resource;search.propiedades.actualizarTotalItems=actualizarTotal;server.data.list(resource,search,function(respuesta){add_items($,respuesta.items,respuesta.consulta);});}}function add_items($,items,consulta){let template=$.metadata.rowTemplate||'_row_tabla_';let jTarget=dom.getById('page_'+$.id);jTarget.empty();for(let item of items){dom.append(jTarget,template,obtener_item_info($,item,items));}$.metadata.search=consulta||{};if($.metadata.pagination){update_pagination($);}let updateHeaders=($.metadata.search.paginacion||{totalItems:items.length}).totalItems >0;update_sortable_headers($,updateHeaders);update_summary($,items);}function obtener_item_info($,item,items){if($.metadata.actions){for(let action of $.metadata.actions){action.show=false;let callback=$.callbacks['show_action_'+action.value];action.show=(callback&&callback(item,items));}}return{id:item[$.metadata.id],columns:$.metadata.columns,item:item,actions:$.metadata.actions};}function generate_on_click_listado_callback($){return function(event){event.stopPropagation();let info=obtener_info_target(event.target);if(info===null){return;}if($.callbacks.on_click_action){$.callbacks.on_click_action(info);}};}function generate_on_click_sortable_column_callback($){return function(event){let jElement=jQuery(event.currentTarget);let search=$.metadata.search;let clave=jElement.data('field');let item=array.findByProperty(search.ordenacion,'campo',clave);if(item===null){search.ordenacion=[{campo:clave,direccion:'asc'}];}else{item.direccion=(item.direccion==='asc')?'desc':'asc';}setTimeout(function(){$.update();},0);};}function update_sortable_headers($,updateHeaders){let items=jQuery('#header_'+$.id+' .sortable');items.children('i').remove();if(updateHeaders){items.each(function(indice,domElement){let jElement=jQuery(domElement);let item=array.findByProperty($.metadata.search.ordenacion,'campo',jElement.data('field'));if(item){jElement.append('<i class="fa fa-sort-'+item.direccion.toLowerCase()+'" aria-hidden="true"></i>');}else{jElement.append('<i class="fa fa-sort" aria-hidden="true"></i>');}});}}function update_summary($,items){if(!$.metadata.summaryTemplate){return;}let total=array.sumProperty(items,'monto');dom.create('footer_'+$.id,$.metadata.summaryTemplate,{columns:$.metadata.columns,total:total});}function obtener_info_target(target){let jTarget=jQuery(target);if(jTarget.is('tr')){return{id:target.id,action:'edit'};}if(jTarget.is('input')){return{item:jTarget};}let renglon=jTarget.parents('tr')[0];if(target.nodeName==='BUTTON'){return{id:renglon.id,action:jTarget.data('action')};}else if(target.nodeName==='I'){jTarget=jTarget.parents(":eq(0)");return{id:renglon.id,action:jTarget.data('action')};}else{return{id:renglon.id,action:'edit'};}}function update_pagination($){let paginacion=$.metadata.search.paginacion;let module=$.metadata.module;let idContenedor='paginador_'+$.id;let idEtiqueta='etiquetaPaginador_'+$.id;var contenedor=dom.getById(idContenedor);contenedor.empty();if(paginacion.totalItems===0){dom.setText(idEtiqueta,"La consulta actual no produjo resultados.");}else{let pagina=paginacion.pagina;let windowSize=3;let totalPaginas=Math.ceil(paginacion.totalItems/paginacion.itemsPagina);let inicial=(((pagina-1)*paginacion.itemsPagina)+1);let final=(pagina*paginacion.itemsPagina);if(paginacion.totalItems <final){final=paginacion.totalItems;}dom.setText(idEtiqueta,"Resultados "+inicial+" a  "+final+" de "+paginacion.totalItems+".");let ventana=obtenerVentana(pagina,windowSize,totalPaginas);if(ventana.start===1){agregarBoton(contenedor,{label:"Previa",type:"disabled",module:module});}else{agregarBoton(contenedor,{label:"Previa",page:pagina-1,type:"normal",module:module});}for(var i=0;i <ventana.length;++i){var nextPagina=ventana.start+i;if(nextPagina===pagina){agregarBoton(contenedor,{label:nextPagina,page:nextPagina,type:"active",module:module});}else{agregarBoton(contenedor,{label:nextPagina,page:nextPagina,type:"normal",module:module});}}if((ventana.start+ventana.length-1)===totalPaginas){agregarBoton(contenedor,{label:"Siguiente",type:"disabled",module:module});}else{agregarBoton(contenedor,{label:"Siguiente",page:pagina+1,type:"normal",module:module});}}}function agregarBoton(jQueryContainer,bean){dom.append(jQueryContainer,'_boton_paginador_',bean);}function obtenerVentana(paginaActual,windowSize,totalPaginas){let mediaVentana=(windowSize-1)/2;if(totalPaginas <=windowSize){return{start:1,length:totalPaginas};}else if(paginaActual <=(totalPaginas-mediaVentana)){let inicio=paginaActual-mediaVentana;if(inicio <=0){inicio=1;}return{start:inicio,length:windowSize};}else{return{start:totalPaginas-windowSize+1,length:windowSize};}}return{init:init,reshape:reshape,update:update,mostrarPagina:obtener_pagina};})();